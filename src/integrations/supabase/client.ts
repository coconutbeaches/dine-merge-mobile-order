// This file is automatically generated. Do not edit it directly.
import { createClient } from '@supabase/supabase-js';
import type { Database } from '@/types/supabaseTypes';

// Use environment variables with fallbacks to hardcoded values
const SUPABASE_URL = process.env.NEXT_PUBLIC_SUPABASE_URL || "https://wcplwmvbhreevxvsdmog.supabase.co";
const SUPABASE_PUBLISHABLE_KEY = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY || "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndjcGx3bXZiaHJlZXZ4dnNkbW9nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY5Njc5MDIsImV4cCI6MjA2MjU0MzkwMn0.lyq2RNg01GDyqkT5yjPSSxs2h3581Hr8QmytpDDzhTo";

// Validate environment variables in development
if (process.env.NODE_ENV === 'development') {
  if (!SUPABASE_URL) {
    console.warn('NEXT_PUBLIC_SUPABASE_URL is not set');
  }
  if (!SUPABASE_PUBLISHABLE_KEY) {
    console.warn('NEXT_PUBLIC_SUPABASE_ANON_KEY is not set');
  }
}

// Import the supabase client like this:
// import { supabase } from "@/integrations/supabase/client";

// Create a custom storage adapter that migrates from cookies to localStorage
const customStorage = typeof window !== 'undefined' ? {
  getItem: (key: string) => {
    // First try localStorage (new method)
    const localStorageValue = window.localStorage.getItem(key);
    if (localStorageValue) {
      return localStorageValue;
    }
    
    // Fallback to cookies for migration (old method)
    const cookieValue = document.cookie
      .split('; ')
      .find(row => row.startsWith(key + '='))
      ?.split('=')[1];
    
    // If found in cookies, migrate to localStorage
    if (cookieValue) {
      window.localStorage.setItem(key, cookieValue);
      // Clear the cookie after migration
      document.cookie = `${key}=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT`;
      return cookieValue;
    }
    
    return null;
  },
  setItem: (key: string, value: string) => {
    // Always use localStorage for new values
    window.localStorage.setItem(key, value);
    // Also clear any existing cookies with the same key
    document.cookie = `${key}=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT`;
  },
  removeItem: (key: string) => {
    window.localStorage.removeItem(key);
    // Also clear from cookies
    document.cookie = `${key}=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT`;
  },
} : undefined;

export const supabase = createClient<Database>(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY, {
  auth: {
    // Enable automatic session refresh
    autoRefreshToken: true,
    // Persist auth session in localStorage to prevent cookie bloat
    persistSession: true,
    // Detect session in URL (for OAuth flows)
    detectSessionInUrl: true,
    // Storage key for session
    storageKey: 'supabase.auth.token',
    // Use custom storage that migrates from cookies to localStorage
    storage: customStorage,
  },
  realtime: {
    connect: true,
    params: { eventsPerSecond: 10 },
    retryAttempts: 6,
    timeout: 40000
  }
});
